name: ghstack
author: Shikanime Deva
branding:
  icon: globe
  color: gray-dark
description: Land a pull request
inputs:
  appId:
    description: The GitHub App ID
    required: true
  privateKey:
    description: The GitHub App private key
    required: true
  command:
    description: The command to run
    default: .ghstack
  reaction:
    description: The reaction to add
    default: rocket
  permissions:
    description: The permissions to check
    default: write,maintain,admin
  username:
    description: The username to use
    default: github-actions[bot]
  email:
    description: The email to use
    default: github-actions[bot]@users.noreply.github.com
  sign-commits:
    description: Set to true if the action should sign the commit with GPG
    default: "false"
  gpg-private-key:
    description: GPG Private Key with which to sign the commits in the PR to be created
    default: ""
  gpg-fingerprint:
    description: Fingerprint of specific GPG subkey to use
    required: false
  gpg-passphrase:
    description: GPG Private Key Passphrase for the GPG Private Key with which to sign the commits in the PR to be created
    default: ""
runs:
  using: composite
  steps:
    - id: createGithubAppToken
      uses: actions/create-github-app-token@v1
      with:
        app-id: ${{ inputs.appId }}
        private-key: ${{ inputs.privateKey }}
    - uses: github/command@v1
      id: command
      with:
        command: ${{ inputs.command }}
        reaction: ${{ inputs.reaction }}
        allowed_contexts: pull_request
        permissions: ${{ inputs.permissions }}
        github_token: ${{ steps.createGithubAppToken.outputs.token }}
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ steps.createGithubAppToken.outputs.token }}
    - uses: DeterminateSystems/nix-installer-action@v13
      if: ${{ steps.command.outputs.continue == 'true' }}
    - uses: DeterminateSystems/magic-nix-cache-action@v8
      if: ${{ steps.command.outputs.continue == 'true' }}
    - shell: bash
      run: |
        nix run nixpkgs#sapling -- config \
          --local ui.username "${{ inputs.username }}" \
          --local ui.email "${{ inputs.email }}"
    - id: importGPG
      uses: crazy-max/ghaction-import-gpg@01dd5d3ca463c7f10f7f4f7b4f177225ac661ee4 # v6.1.0
      with:
        gpg_private_key: ${{ inputs.gpg-private-key }}
        fingerprint: ${{ inputs.gpg-fingerprint }}
        passphrase: ${{ inputs.gpg-passphrase }}
        git_config_global: true
        git_user_signingkey: true
        git_commit_gpgsign: true
    - shell: bash
      run: |
        nix run nixpkgs#sapling -- config \
          --local user.signingkey "${{ steps.importGPG.outputs.keyid }}" \
          --local commit.gpgsign true
      if: ${{ inputs.sign-commits == 'true' }}
    - shell: bash
      run: |
        nix run nixpkgs#sapling -- ghstack land \
          ${{ github.event.issue.pull_request.html_url }}
      if: ${{ steps.command.outputs.continue == 'true' }}
      env:
        GH_TOKEN: ${{ steps.createGithubAppToken.outputs.token }}

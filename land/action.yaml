name: land
description: Land pull request from a PR comment
inputs:
  base:
    default: main
    description: The base branch to rebase onto
    required: false
  email:
    default: github-actions[bot]@users.noreply.github.com
    description: Email
    required: false
  extra-args:
    default: ""
    description: Extra arguments to pass to `nix run`
    required: false
  fullname:
    default: github-actions[bot]
    description: Full name
    required: false
  github-token:
    default: ${{ github.token }}
    description: The GitHub Token
    required: false
  gpg-passphrase:
    default: ""
    description: GPG private key passphrase
    required: false
  gpg-private-key:
    default: ""
    description: GPG private key for signing commits
    required: false
  permissions:
    default: write,maintain,admin
    description: Permissions to require for the command
    required: false
  pull-request-url:
    default: ${{ github.event.issue.pull_request.html_url }}
    description: The Pull Request URL
    required: false
  reaction:
    default: rocket
    description: Reaction to add to the triggering comment
    required: false
  registry:
    default: nixpkgs
    description: Nix registry to use
    required: false
  sign-commits:
    default: "false"
    description: Set to true to sign commits with GPG
    required: false
  username:
    default: github-actions
    description: Username
    required: false
runs:
  using: composite
  steps:
    - id: command
      uses: github/command@v1
      with:
        allowed_contexts: pull_request
        command: .land
        github_token: ${{ inputs.github-token }}
        permissions: ${{ inputs.permissions }}
        reaction: ${{ inputs.reaction }}
    - id: stack
      if: steps.command.outputs.continue == 'true'
      uses: shikanime-studio/actions/stack@main
      with:
        github-token: ${{ inputs.github-token }}
        pull-request-url: ${{ inputs.pull-request-url }}
    - env:
        METHOD: ${{ steps.stack.outputs.method }}
        PARAMS: ${{ steps.command.outputs.params }}
      id: pull_request
      if: steps.command.outputs.continue == 'true'
      run: |
        CMD_METHOD=""

        if [ -n "$PARAMS" ]; then
          case "$PARAMS" in
            ghstack)
              CMD_METHOD="ghstack"
              ;;
            slpr)
              CMD_METHOD="sapling-pull-request"
              ;;
            ghpr)
              CMD_METHOD="github-pull-request"
              ;;
            *)
              echo "Unknown land method param '$PARAMS'. Expected 'ghstack', 'slpr' or 'ghpr'."
              exit 1
              ;;
          esac
        else
          CMD_METHOD="$METHOD"
        fi

        echo "method=$CMD_METHOD" >> "$GITHUB_OUTPUT"
      shell: bash
    - env:
        EMAIL: ${{ inputs.email }}
        EXTRA_ARGS: ${{ inputs.extra-args }}
        FULLNAME: ${{ inputs.fullname }}
        REGISTRY: ${{ inputs.registry }}
      if: steps.command.outputs.continue == 'true'
      run: |
        nix run "$REGISTRY#sapling" $EXTRA_ARGS -- config \
          --local ui.username "$FULLNAME <$EMAIL>"
      shell: bash
    - id: importGPG
      if: |
        inputs.sign-commits == 'true' &&
        steps.command.outputs.continue == 'true'
      uses: crazy-max/ghaction-import-gpg@v6
      with:
        git_commit_gpgsign: true
        git_user_signingkey: true
        gpg_private_key: ${{ inputs.gpg-private-key }}
        passphrase: ${{ inputs.gpg-passphrase }}
    - env:
        EXTRA_ARGS: ${{ inputs.extra-args }}
        GPG_KEY_ID: ${{ steps.importGPG.outputs.keyid }}
        REGISTRY: ${{ inputs.registry }}
      if: |
        inputs.sign-commits == 'true' &&
        steps.pull_request.outputs.method == 'sapling-pull-request' &&
        steps.command.outputs.continue == 'true'
      run: |
        nix run "$REGISTRY#sapling" $EXTRA_ARGS -- config \
          --local gpg.key "$GPG_KEY_ID" \
          --local commit.gpgsign true
      shell: bash
    - env:
        GH_TOKEN: ${{ inputs.github-token }}
        USERNAME: ${{ inputs.username }}
      if: |
        steps.pull_request.outputs.method == 'ghstack' &&
        steps.command.outputs.continue == 'true'
      run: |
        GHSTACKRC_PATH=$(mktemp)
        cat > "$GHSTACKRC_PATH" <<EOF
        [ghstack]
        github_url = github.com
        github_oauth = $GH_TOKEN
        github_username = $USERNAME
        EOF
        echo "GHSTACKRC_PATH=$GHSTACKRC_PATH" >> "$GITHUB_ENV"
      shell: bash
    - env:
        EXTRA_ARGS: ${{ inputs.extra-args }}
        GHSTACKRC_PATH: ${{ env.GHSTACKRC_PATH }}
        PR_URL: ${{ inputs.pull-request-url }}
        REGISTRY: ${{ inputs.registry }}
      if: |
        steps.pull_request.outputs.method == 'ghstack' &&
        steps.command.outputs.continue == 'true'
      run: |
        nix run "$REGISTRY#ghstack" $EXTRA_ARGS -- land \
          "$PR_URL"
      shell: bash
    - env:
        BASE: ${{ inputs.base }}
        EXTRA_ARGS: ${{ inputs.extra-args }}
        GH_TOKEN: ${{ inputs.github-token }}
        PR_URL: ${{ inputs.pull-request-url }}
        REGISTRY: ${{ inputs.registry }}
      if: |
        steps.pull_request.outputs.method == 'sapling-pull-request' &&
        steps.command.outputs.continue == 'true'
      run: |
        nix run "$REGISTRY#sapling" $EXTRA_ARGS -- pr pull \
          --goto \
          "$PR_URL"
        nix run "$REGISTRY#sapling" $EXTRA_ARGS -- rebase \
          --dest "$BASE"
        nix run "$REGISTRY#sapling" $EXTRA_ARGS -- push \
          --to "$BASE"
        nix run "$REGISTRY#sapling" $EXTRA_ARGS -- push \
          --delete $(
            gh pr view \
              "$PR_URL" \
              --json headRefName \
              -q .headRefName
          )
      shell: bash
    - env:
        GH_TOKEN: ${{ inputs.github-token }}
        PR_URL: ${{ inputs.pull-request-url }}
      if: |
        steps.pull_request.outputs.method == 'github-pull-request' &&
        steps.command.outputs.continue == 'true'
      run: |
        gh pr merge \
          --rebase \
          --delete-branch \
          "$PR_URL"
      shell: bash

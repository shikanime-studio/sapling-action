name: land
description: Land pull request from a PR comment
inputs:
  base:
    description: The base branch to rebase onto
    required: false
    default: main
  extra-args:
    description: Extra arguments to pass to `nix run`
    required: false
    default: ""
  github-token:
    description: The GitHub Token
    required: false
    default: ${{ github.token }}
  ghstack-username:
    description: Ghstack username
    required: false
    default: github-actions
  gpg-passphrase:
    description: GPG private key passphrase
    required: false
    default: ""
  gpg-private-key:
    description: GPG private key for signing commits
    required: false
    default: ""
  permissions:
    description: Permissions to require for the command
    required: false
    default: write,maintain,admin
  reaction:
    description: Reaction to add to the triggering comment
    required: false
    default: rocket
  registry:
    description: Nix registry to use
    required: false
    default: nixpkgs
  sign-commits:
    description: Set to true to sign commits with GPG
    required: false
    default: "false"
  username:
    description: Sapling username to configure
    required: false
    default: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
runs:
  using: composite
  steps:
    - uses: github/command@v1
      id: command
      with:
        command: .land
        reaction: ${{ inputs.reaction }}
        allowed_contexts: pull_request
        permissions: ${{ inputs.permissions }}
        github_token: ${{ inputs.github-token }}
    - shell: bash
      run: |
        nix run "${{ inputs.registry }}#sapling" ${{ inputs.extra-args }} -- config \
          --local ui.username "${{ inputs.username }}"
      if: steps.command.outputs.continue == 'true'
    - id: importGPG
      uses: crazy-max/ghaction-import-gpg@v6
      with:
        git_commit_gpgsign: true
        git_user_signingkey: true
        gpg_private_key: ${{ inputs.gpg-private-key }}
        passphrase: ${{ inputs.gpg-passphrase }}
      if: |
        inputs.sign-commits == 'true' &&
        steps.command.outputs.continue == 'true'
    - shell: bash
      run: |
        nix run "${{ inputs.registry }}#sapling" ${{ inputs.extra-args }} -- config \
          --local gpg.key "${{ steps.importGPG.outputs.keyid }}" \
          --local commit.gpgsign true
      if: |
        inputs.sign-commits == 'true' &&
        steps.command.outputs.continue == 'true'
    - shell: bash
      run: |
        cat > ~/.ghstackrc <<EOF
        [ghstack]
        github_url = github.com
        github_oauth = ${{ inputs.github-token }}
        github_username = ${{ inputs.ghstack-username }}
        EOF
      if: |
        steps.command.outputs.params != 'pr' &&
        steps.command.outputs.continue == 'true'
    - name: Land Pull Request
      shell: bash
      run: |
        PR_URL="${{ github.event.issue.pull_request.html_url }}"
        PARAMS="${{ steps.command.outputs.params }}"
        BRANCH=$(gh pr view "$PR_URL" --json headRefName -q .headRefName)

        MODE=""

        if [ -n "$PARAMS" ]; then
          case "$PARAMS" in
            gh|ghstack)
              MODE="ghstack"
              ;;
            pr|sapling)
              MODE="sapling"
              ;;
            gh-cli|github)
              MODE="github"
              ;;
            *)
              MODE="$PARAMS"
              ;;
          esac
        else
          if [[ "$BRANCH" == gh/* ]]; then
            MODE="ghstack"
          elif [[ "$BRANCH" =~ ^pr[0-9]+$ ]]; then
            MODE="sapling"
          else
            MODE="github"
          fi
        fi

        if [ "$MODE" = "ghstack" ]; then
          nix run "${{ inputs.registry }}#ghstack" ${{ inputs.extra-args }} -- land \
            "$PR_URL"
        elif [ "$MODE" = "sapling" ]; then
          nix run "${{ inputs.registry }}#sapling" ${{ inputs.extra-args }} -- pr pull \
            --goto \
            "$PR_URL"
          nix run "${{ inputs.registry }}#sapling" ${{ inputs.extra-args }} -- rebase \
            --dest ${{ inputs.base }}
          nix run "${{ inputs.registry }}#sapling" ${{ inputs.extra-args }} -- push \
            --to ${{ inputs.base }}
          nix run "${{ inputs.registry }}#sapling" ${{ inputs.extra-args }} -- push \
            --delete $(
              gh pr view \
                "$PR_URL" \
                --json headRefName \
                -q .headRefName
            )
        else
          gh pr merge \
            --merge \
            --delete-branch \
            "$PR_URL"
        fi
      if: steps.command.outputs.continue == 'true'
      env:
        GH_TOKEN: ${{ inputs.github-token }}
